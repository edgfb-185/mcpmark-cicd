name: Deployment Status

on:
  push:
    branches: [main]

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
      prev_commit: ${{ steps.get-prev-commit.outputs.prev_commit }}
      package_version: ${{ steps.get-package-version.outputs.package_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Get previous commit

      - name: Install dependencies
        run: npm ci

      - name: Run lint checks
        run: npm run lint --if-present

      - name: Run tests
        run: npm run test --if-present

      - name: Get previous commit SHA
        id: get-prev-commit
        run: echo "prev_commit=$(git rev-parse HEAD~1)" >> "$GITHUB_OUTPUT"

      - name: Get package version
        id: get-package-version
        run: echo "package_version=$(npm pkg get version | tr -d '\"')" >> "$GITHUB_OUTPUT"

      - name: Create deployment tracking issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const commitSha = context.sha;
            const issue = await github.rest.issues.create({
              owner,
              repo,
              title: `Deployment Tracking - ${commitSha}`,
              labels: ['deployment', 'in-progress'],
              body: `# Deployment Tracking: ${commitSha}\n\nThis issue tracks the deployment process for commit ${commitSha}.`
            });
            return { issue_number: issue.data.number };

      - name: Post pre-deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: ${{ steps.create-issue.outputs.issue_number }},
              body: "Pre-deployment checks completed"
            });

  rollback-preparation:
    name: rollback-preparation
    runs-on: ubuntu-latest
    needs: pre-deployment
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare rollback artifacts
        id: prepare-artifacts
        run: |
          # Create rollback directory
          mkdir -p rollback-package/backup

          # 1. Create rollback script with error handling
          cat > rollback-package/rollback.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          echo "=== Starting Rollback Process ==="
          echo "Rolling back to commit: $1"

          # Verify git exists
          if ! command -v git &> /dev/null; then
              echo "ERROR: git is not installed"
              exit 1
          fi

          # Checkout previous commit
          git checkout "$1"
          echo "âœ… Checked out previous commit"

          # Reinstall dependencies
          npm ci
          echo "âœ… Reinstalled dependencies"

          # Verify package version
          echo "âœ… Rollback completed successfully"
          exit 0
          EOF

          chmod +x rollback-package/rollback.sh
          echo "âœ… Created executable rollback script"

          # 2. Create configuration backups
          cp package.json package-lock.json rollback-package/backup/
          # Create sample environment template if it doesn't exist
          cat > rollback-package/backup/env-template.env << 'EOF'
          # Sample environment template
          NODE_ENV=production
          PORT=3000
          EOF
          echo "âœ… Created configuration backups"

          # 3. Create dependency verification script
          cat > rollback-package/verify-deps.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          echo "=== Verifying Dependency Compatibility ==="
          npm audit
          echo "âœ… Dependencies verified"

          # Check for required packages
          REQUIRED_PACKAGES=("express" "typescript" "eslint")
          for pkg in "${REQUIRED_PACKAGES[@]}"; do
              if npm list "$pkg" > /dev/null 2>&1; then
                  echo "âœ… $pkg is installed"
              else
                  echo "âš ï¸  $pkg is missing (optional)"
              fi
          done

          exit 0
          EOF

          chmod +x rollback-package/verify-deps.sh
          echo "âœ… Created dependency verification script"

          # 4. Create rollback documentation
          cat > rollback-package/rollback-docs.md << EOF
          # Rollback Documentation
          ## Step-by-Step Rollback Instructions
          1. Download and extract the rollback package
          2. Make rollback script executable: \`chmod +x rollback.sh\`
          3. Run rollback script with previous commit: \`./rollback.sh ${{ needs.pre-deployment.outputs.prev_commit }}\`
          4. Verify the rollback completed successfully
          5. Restart the application service

          ## Artifact Contents
          - \`rollback.sh\`: Main rollback script
          - \`backup/\`: Configuration backups
          - \`verify-deps.sh\`: Dependency verification
          - \`rollback-docs.md\`: This documentation
          EOF
          echo "âœ… Created rollback documentation"

          # 5. Compress rollback package
          ARTIFACT_NAME="rollback-package-${{ github.sha }}"
          tar -czf "$ARTIFACT_NAME.tar.gz" rollback-package/
          echo "artifact_name=$ARTIFACT_NAME.tar.gz" >> "$GITHUB_OUTPUT"

          # 6. Generate SHA256 checksum
          CHECKSUM=$(sha256sum "$ARTIFACT_NAME.tar.gz" | awk '{print $1}')
          echo "checksum=$CHECKSUM" >> "$GITHUB_OUTPUT"

      - name: Upload rollback artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prepare-artifacts.outputs.artifact_name }}
          path: ${{ steps.prepare-artifacts.outputs.artifact_name }}
          retention-days: 30

      - name: Post rollback plan comment
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            const prevCommit = "${{ needs.pre-deployment.outputs.prev_commit }}";
            const currentCommit = context.sha;
            const packageVersion = "${{ needs.pre-deployment.outputs.package_version }}";
            const artifactName = "${{ steps.prepare-artifacts.outputs.artifact_name }}";
            const checksum = "${{ steps.prepare-artifacts.outputs.checksum }}";

            const commentBody = `
## ðŸ”„ Rollback Plan Ready

### Deployment Information
- Previous Commit: ${prevCommit}
- Current Commit: ${currentCommit}
- Package Version: ${packageVersion}
- Artifact: ${artifactName}

### Completed Rollback Components
âœ… Executable rollback script created
âœ… Configuration backups (package.json, package-lock.json, env templates)
âœ… Dependency verification script
âœ… Detailed rollback documentation
âœ… Compressed rollback package with checksums

### Quick Rollback Command
\`\`\`bash
# Extract artifact
tar -xzf ${artifactName}
cd rollback-package/

# Run rollback
./rollback.sh ${prevCommit}
\`\`\`

### Verification Status
- Rollback script created: true
- Configuration backup: true
- SHA256: ${checksum}
`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: commentBody
            });

  post-deployment:
    name: post-deployment
    runs-on: ubuntu-latest
    needs: rollback-preparation
    steps:
      - name: Update issue labels
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};

            // Remove in-progress label
            await github.rest.issues.removeLabel({
              owner,
              repo,
              issue_number: issueNumber,
              name: "in-progress"
            });

            // Add completed label
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: ["completed"]
            });

      - name: Post final deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            const artifactName = "${{ needs.rollback-preparation.outputs.artifact_name || 'rollback-package-' + context.sha + '.tar.gz' }}";

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: `## Deployment Completed Successfully

Rollback artifact: \`${artifactName}\` is available for 30 days if rollback is needed.
`
            });

      - name: Close deployment issue
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};

            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issueNumber,
              state: "closed",
              state_reason: "completed"
            });